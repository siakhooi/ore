#!/bin/bash

# shellcheck disable=SC1091
source /usr/lib/ore/ore-init

usage() {
	echo "Run download and distribution of artifacts"
	echo "Usage: $(basename "$0") [-h] [-g group] artifact..."
	echo "-g group   Specify a group of artifacts to download (can be used multiple times)"
	echo "-h         Show this help message"
}
groups=()
while getopts "hg:" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	g)
		groups+=("$OPTARG")
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))

artifacts=()
artifacts+=("$@")

for group in "${groups[@]}"; do
	while IFS= read -r artifact; do
		artifacts+=("$artifact")
	done < <(ore-config '.download.'"$group"'[][].name')
done

if [[ ${#artifacts[@]} -eq 0 ]]; then
	usage >&2
	exit 0
fi

echo.debug "downloading:" "${artifacts[@]}"

for artifact in "${artifacts[@]}"; do
	ore-download "$artifact"
	ore-distribute "$artifact"
done
