#!/bin/bash

# shellcheck disable=SC1091
source /usr/lib/ore/ore-init

usage() {
	echo "Run download and distribution of artifacts"
	echo "Usage: $(basename "$0") [-h] [-g download_group] [-G distribution_group] artifact..."
	echo "-g download_group       Specify a group of artifacts to download (can be used multiple times)"
	echo "-G distribution_group   Specify a group of artifacts to distribute (can be used multiple times)"
	echo "-h         Show this help message"
}
download_groups=()
distribution_groups=()
while getopts "hg:G:" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	g)
		download_groups+=("$OPTARG")
		;;
	G)
		distribution_groups+=("$OPTARG")
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))

download_artifacts=()
download_artifacts+=("$@")
distribution_artifacts=()
distribution_artifacts+=("$@")

for group in "${download_groups[@]}"; do
	while IFS= read -r artifact; do
		download_artifacts+=("$artifact")
	done < <(ore-config '.download.'"$group"'[][].name')
done
for group in "${distribution_groups[@]}"; do
	while IFS= read -r artifact; do
		distribution_artifacts+=("$artifact")
	done < <(ore-config '.distribution.'"$group"'[][].name')
done

if [[ ${#download_artifacts[@]} -eq 0 ]] && [[ ${#distribution_artifacts[@]} -eq 0 ]]; then
	usage >&2
	exit 0
fi

exit_code=0
for artifact in "${download_artifacts[@]}"; do
	if ! ore-download "$artifact"; then
		((exit_code++))
	fi
done

for artifact in "${distribution_artifacts[@]}"; do
	if ! ore-distribute "$artifact"; then
		((exit_code++))
	fi
done

exit $exit_code
