#!/bin/bash

# shellcheck disable=SC1091
source /usr/lib/ore/ore-init

usage() {
	echo "Usage: $(basename "$0") [-h] artifact [version]"
}
while getopts "h" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))

if [[ $# -ne 1 ]] && [[ $# -ne 2 ]]; then
	usage
	exit 0
fi

readonly artifact=$1
version=$2

distribution_type=$(ore-config '.distribution | to_entries | .[] | .value | to_entries | .[] | select(.value[] | select(.name == "'"$artifact"'")) | .key')
config=$(ore-config '.distribution | to_entries | .[] | .value | to_entries | .[] | .value[]| select(.name == "'"$artifact"'")')

echo.debug "Distribution type: $distribution_type"
echo.debug "Artifact: $artifact"
options=("$artifact" "$config")

if [[ $# -eq 2 ]]; then
	echo.debug "Version: $version"
	options+=("$version")
fi

exit_code=0

if [[ "$distribution_type" == "app" ]]; then
	if ! "$ORE_LIB_HOME/ore-distribute-app" "${options[@]}"; then
		((exit_code++))
	fi

elif [[ "$distribution_type" == "bin" ]]; then
	if ! "$ORE_LIB_HOME/ore-distribute-bin" "${options[@]}"; then
		((exit_code++))
	fi

elif [[ "$distribution_type" == "custom" ]]; then
	if ! "$ORE_LIB_HOME/ore-distribute-custom" "${options[@]}"; then
		((exit_code++))
	fi

elif [[ "$distribution_type" == "deb" ]]; then
	if ! "$ORE_LIB_HOME/ore-distribute-deb" "${options[@]}"; then
		((exit_code++))
	fi

elif [[ "$distribution_type" == "jarcli" ]]; then
	if ! "$ORE_LIB_HOME/ore-distribute-jarcli" "${options[@]}"; then
		((exit_code++))
	fi

else
	echo.error "Artifact not supported: $artifact"
	((exit_code++))
fi

exit $exit_code
