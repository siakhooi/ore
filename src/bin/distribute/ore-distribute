#!/bin/bash

# shellcheck disable=SC1091
source /usr/lib/ore/ore-init
source /home/sing/.mygh/ore/src/lib/ore-init
usage() {
	echo "Usage: $(basename "$0") [-h] artifact [version]"
}
while getopts "h" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))

if [[ $# -ne 1 ]] && [[ $# -ne 2 ]]; then
	usage
	exit 0
fi

readonly artifact=$1
version=$2

distribution_type=$(ore-config '.distribution | to_entries | .[] | select(.value[] | select(.name == "'"$artifact"'")) | .key')
config=$(ore-config '.distribution |  to_entries | .[] | .value[]| select(.name == "'"$artifact"'")')

if [[ $# -eq 2 ]]; then
	source_path=$(ore-artifact "$artifact" "$version")
else
	source_path=$(ore-artifact -l "$artifact")
  versionRegex=$(echo "$config"|yq -r '.versionRegex // ""' )
	readonly default_version_regex='^'$artifact'-\([^-]*\)\(\.zip\|\.tgz\|\.tar\.gz\|\.tar\.bz2\|\.tar\.xz\|\.tbz2\|\.txz\|\.tar\)$'
	versionRegex=${versionRegex:-$default_version_regex}
	version=$(basename "$source_path" | sed 's/'"$versionRegex"'/\1/')

fi
echo.debug "Distribution type: $distribution_type"
echo.debug "Artifact: $artifact"
echo.debug "Source path: $source_path"
echo.debug "Version: $version"

options=("$artifact" "$version" "$source_path" "$config")

if [[ "$distribution_type" == "app" ]]; then
	"$ORE_LIB_HOME/ore-distribute-app" "${options[@]}"


else
	echo.error "Artifact not supported: $artifact"
	exit 2
fi
