#!/bin/bash

# shellcheck disable=SC1091
source /usr/lib/ore/ore-init

usage() {
	echo "Usage: $(basename "$0") [-h] artifact_name"
}

while getopts "h" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))

if [[ $# -ne 1 ]]; then
	usage >&2
	exit 0
fi

readonly artifact_name=$1

download_type=$(ore-config '.download | to_entries | .[] | .value | to_entries | .[] | select(.value[] | select(.name == "'"$artifact_name"'")) | .key')
options=$(ore-config '.download | to_entries | .[] | .value | to_entries | .[] | .value[]| select(.name == "'"$artifact_name"'")')

# Check if multiple download types were found
line_count=$(echo "$download_type" | grep -c '^')
if [[ $line_count -gt 1 ]]; then
	echo.error "Error: Multiple download types found for artifact '$artifact_name'"
	echo.error "Found: $download_type"
	exit 2
fi

if [[ "$download_type" == "url" ]]; then
	"$ORE_LIB_HOME/ore-download-url" "$artifact_name" "$options"

elif [[ "$download_type" == "url-template-version" ]]; then
	"$ORE_LIB_HOME/ore-download-url-template-version" "$artifact_name" "$options"

else
	echo.error "Artifact not supported: $artifact_name"
	exit 2
fi
