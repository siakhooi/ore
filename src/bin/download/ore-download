#!/bin/bash

# shellcheck disable=SC1091
source /usr/lib/ore/ore-init

usage() {
	echo "Usage: $(basename "$0") [-h] [-g group] artifact..."
  echo "-g group   Specify a group of artifacts to download (can be used multiple times)"
  echo "-h         Show this help message"
}
groups=()
while getopts "hg:" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	g)
		groups+=("$OPTARG")
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))

artifacts=()
artifacts+=("$@")

for group in "${groups[@]}"; do
  while IFS= read -r artifact; do
    artifacts+=("$artifact")
  done < <(ore-config '.download.'"$group"'[][].name')
done

if [[ ${#artifacts[@]} -eq 0 ]]; then
  usage >&2
  exit 0
fi

echo.debug "downloading:" "${artifacts[@]}"

exit_code=0
for artifact in "${artifacts[@]}"; do

	download_type=$(ore-config '.download | to_entries | .[] | .value | to_entries | .[] | select(.value[] | select(.name == "'"$artifact"'")) | .key')
	config=$(ore-config '.download | to_entries | .[] | .value | to_entries | .[] | .value[]| select(.name == "'"$artifact"'")')

	# Check if multiple download types were found
	line_count=$(echo "$download_type" | grep -c '^')
	if [[ $line_count -gt 1 ]]; then
		echo.error "Error: Multiple download types found for artifact '$artifact'"
		echo.error "Found: $download_type"
		((exit_code++))
		continue
	fi

	if [[ "$download_type" == "url" ]]; then
		if ! "$ORE_LIB_HOME/ore-download-url" "$artifact" "$config"; then
			((exit_code++))
		fi

	elif [[ "$download_type" == "url-template-version" ]]; then
		if ! "$ORE_LIB_HOME/ore-download-url-template-version" "$artifact" "$config"; then
			((exit_code++))
		fi

	elif [[ "$download_type" == "sdkman" ]]; then
		if ! "$ORE_LIB_HOME/ore-download-sdkman" "$artifact" "$config"; then
			((exit_code++))
		fi

	elif [[ "$download_type" == "github" ]]; then
		if ! "$ORE_LIB_HOME/ore-download-github" "$artifact" "$config"; then
			((exit_code++))
		fi

	elif [[ "$download_type" == "jfrog" ]]; then
		if ! "$ORE_LIB_HOME/ore-download-jfrog" "$artifact" "$config"; then
			((exit_code++))
		fi

	elif [[ "$download_type" == "custom" ]]; then
		if ! "$ORE_LIB_HOME/ore-download-custom" "$artifact" "$config"; then
			((exit_code++))
		fi

	else
		echo.error "Artifact not supported: $artifact"
		((exit_code++))
	fi
done

exit $exit_code
